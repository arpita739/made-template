<html>
<head>
<title>pipeline.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #47a2ed;}
.s1 { color: #d4d4d4;}
.s2 { color: #699856;}
.s3 { color: #fdfcfc;}
.s4 { color: #cd9069;}
.s5 { color: #d7ba7d;}
.s6 { color: #b4cda8;}
</style>
</head>
<body bgcolor="#1e1e1e">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pipeline.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">sqlite3</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">requests</span>
<span class="s2">#import kaggle</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">import </span><span class="s1">pycountry</span>
<span class="s2">#from kaggle.api.kaggle_api_extended import KaggleApi</span>
<span class="s0">import </span><span class="s1">zipfile</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">def </span><span class="s1">extract_and_move(old_name</span><span class="s3">: </span><span class="s1">str, new_name</span><span class="s3">: </span><span class="s1">str, extract_path</span><span class="s3">: </span><span class="s1">str)</span><span class="s3">:</span>
    <span class="s1">shutil.move(old_name, new_name)</span>
    <span class="s0">with </span><span class="s1">zipfile.ZipFile(new_name, </span><span class="s4">'r'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">zip_ref</span><span class="s3">:</span>
        <span class="s1">zip_ref.extractall(extract_path)</span>

<span class="s2"># Set paths using os.path.join for platform independence</span>
<span class="s1">data</span><span class="s3">= </span><span class="s4">'../data'</span>
<span class="s2">#data_folder = '../project'</span>
<span class="s2">#dataset_folder = os.path.join(data_folder, 'dataset-folder')</span>
<span class="s1">clean_salary_db_path </span><span class="s3">= </span><span class="s1">os.path.join(data, </span><span class="s4">'clean_salary.sqlite'</span><span class="s1">)</span>
<span class="s1">ds_salary_db_path </span><span class="s3">= </span><span class="s1">os.path.join(data, </span><span class="s4">'ds_salaries.sqlite'</span><span class="s1">)</span>
<span class="s1">cleancsv_path </span><span class="s3">= </span><span class="s4">'../dataset-folder/salary_data_cleaned.csv'</span>
<span class="s1">ds_salary_path </span><span class="s3">= </span><span class="s4">'../dataset-folder/ds_salaries.csv'</span>


<span class="s2">#api = KaggleApi()</span>
<span class="s2">#api.authenticate()</span>

<span class="s2"># Example:</span>
<span class="s2">#api.dataset_download_file('thedevastator/jobs-dataset-from-glassdoor','file.zip')</span>

<span class="s2">#extract_and_move('file.zip', dataset_folder, data_folder)</span>

<span class="s2"># Read CSV file</span>
<span class="s1">file_path </span><span class="s3">= </span><span class="s4">'../dataset-folder/salary_data_cleaned.csv'</span>
<span class="s1">cleancsv_df </span><span class="s3">= </span><span class="s1">pd.read_csv(file_path)</span>
<span class="s2"># Define a function to extract the company name before '\n'</span>
<span class="s0">def </span><span class="s1">extract_company_name(row)</span><span class="s3">:</span>
    <span class="s0">return </span><span class="s1">row[</span><span class="s4">'Company Name'</span><span class="s1">].split(</span><span class="s4">'</span><span class="s5">\n</span><span class="s4">'</span><span class="s1">)[</span><span class="s6">0</span><span class="s1">]</span>

<span class="s2"># Apply the function to create a new column 'company'</span>
<span class="s1">cleancsv_df[</span><span class="s4">'company'</span><span class="s1">] </span><span class="s3">= </span><span class="s1">cleancsv_df.apply(</span><span class="s0">lambda </span><span class="s1">row</span><span class="s3">: </span><span class="s1">extract_company_name(row), axis</span><span class="s3">=</span><span class="s6">1</span><span class="s1">)</span>
<span class="s2"># Drop the original 'Company Name' column</span>
<span class="s1">cleancsv_df </span><span class="s3">= </span><span class="s1">cleancsv_df.drop(columns</span><span class="s3">=</span><span class="s1">[</span><span class="s4">'Company Name'</span><span class="s1">])</span>

<span class="s2"># Cleaning</span>
<span class="s1">cleancsv_df </span><span class="s3">= </span><span class="s1">cleancsv_df[(cleancsv_df[</span><span class="s4">'Sector'</span><span class="s1">] </span><span class="s3">!= </span><span class="s4">'unknown'</span><span class="s1">) </span><span class="s3">&amp; </span><span class="s1">(cleancsv_df[</span><span class="s4">'Sector'</span><span class="s1">] </span><span class="s3">!= </span><span class="s4">'-1'</span><span class="s1">)]</span>

<span class="s2"># Save to SQLite database</span>
<span class="s0">with </span><span class="s1">sqlite3.connect(clean_salary_db_path) </span><span class="s0">as </span><span class="s1">conn</span><span class="s3">:</span>
    <span class="s1">cleancsv_df.to_sql(</span><span class="s4">'clean_salary'</span><span class="s1">, conn, index</span><span class="s3">=</span><span class="s0">False</span><span class="s1">, if_exists</span><span class="s3">=</span><span class="s4">'replace'</span><span class="s1">)</span>

<span class="s1">print(</span><span class="s4">&quot;American Salary Data loaded successfully!&quot;</span><span class="s1">)</span>

<span class="s1">path2 </span><span class="s3">= </span><span class="s4">'../dataset-folder/ds_salaries.csv'</span>
<span class="s1">dsSalary_df </span><span class="s3">= </span><span class="s1">pd.read_csv(path2)</span>
<span class="s2"># Transformation of the codes of the categorical variables</span>

<span class="s1">dsSalary_df[</span><span class="s4">'experience_level'</span><span class="s1">] </span><span class="s3">= </span><span class="s1">dsSalary_df[</span><span class="s4">'experience_level'</span><span class="s1">].replace(</span>
    <span class="s1">{</span><span class="s4">'SE'</span><span class="s3">: </span><span class="s4">'Expert'</span><span class="s1">, </span><span class="s4">'MI'</span><span class="s3">: </span><span class="s4">'Intermediate'</span><span class="s1">, </span><span class="s4">'EN'</span><span class="s3">: </span><span class="s4">'Junior'</span><span class="s1">, </span><span class="s4">'EX'</span><span class="s3">: </span><span class="s4">'Director'</span><span class="s1">})</span>

<span class="s1">dsSalary_df[</span><span class="s4">'employment_type'</span><span class="s1">] </span><span class="s3">= </span><span class="s1">dsSalary_df[</span><span class="s4">'employment_type'</span><span class="s1">].replace(</span>
    <span class="s1">{</span><span class="s4">'FT'</span><span class="s3">: </span><span class="s4">'Full-time'</span><span class="s1">, </span><span class="s4">'CT'</span><span class="s3">: </span><span class="s4">'Contract'</span><span class="s1">, </span><span class="s4">'FL'</span><span class="s3">: </span><span class="s4">'Freelance'</span><span class="s1">, </span><span class="s4">'PT'</span><span class="s3">: </span><span class="s4">'Part-time'</span><span class="s1">})</span>


<span class="s0">def </span><span class="s1">country_name(country_code)</span><span class="s3">:</span>
    <span class="s0">try</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s1">pycountry.countries.get(alpha_2</span><span class="s3">=</span><span class="s1">country_code).name</span>
    <span class="s0">except</span><span class="s3">:</span>
        <span class="s0">return </span><span class="s4">'other'</span>


<span class="s1">dsSalary_df[</span><span class="s4">'company_location'</span><span class="s1">] </span><span class="s3">= </span><span class="s1">dsSalary_df[</span><span class="s4">'company_location'</span><span class="s1">].apply(country_name)</span>
<span class="s1">dsSalary_df[</span><span class="s4">'employee_residence'</span><span class="s1">] </span><span class="s3">= </span><span class="s1">dsSalary_df[</span><span class="s4">'employee_residence'</span><span class="s1">].apply(country_name)</span>

<span class="s2"># Save to SQLite database</span>
<span class="s0">with </span><span class="s1">sqlite3.connect(ds_salary_db_path) </span><span class="s0">as </span><span class="s1">conn</span><span class="s3">:</span>
    <span class="s1">dsSalary_df.to_sql(</span><span class="s4">'ds_salaries'</span><span class="s1">, conn, index</span><span class="s3">=</span><span class="s0">False</span><span class="s1">, if_exists</span><span class="s3">=</span><span class="s4">'replace'</span><span class="s1">)</span>

<span class="s1">print(</span><span class="s4">&quot;Global Data Science Salary Data loaded successfully!&quot;</span><span class="s1">)</span>

</pre>
</body>
</html>